name: "XOXO- Dev Container Prebuild (hormigasais-lab)"

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  # 1. TRABAJO DE DEPENDENCIA (Verifica la existencia del archivo .XOXO_TOKEN_READY)
  dependency_check:
    runs-on: ubuntu-latest
    steps:
      - name: Descargar Repositorio Fuente (Thrumanshow)
        uses: actions/checkout@v3
        with:
          repository: Thrumanshow/Thrumanshow
          path: thrumanshow-source
          
      - name: Verificar Token de XOXO
        id: token_check
        run: |
          TOKEN_PATH="./thrumanshow-source/.XOXO_TOKEN_READY"
          
          echo "Buscando el token de dependencia: ${TOKEN_PATH}"
          
          if [ -f "$TOKEN_PATH" ]; then
            echo "✅ ¡Token de XOXO encontrado! La dependencia está satisfecha."
            echo "token_present=true" >> $GITHUB_OUTPUT
          else
            echo "❌ ¡ERROR! El token .XOXO_TOKEN_READY NO fue encontrado en el repositorio de Thrumanshow."
            exit 1 
          fi

  # 2. TRABAJO PRINCIPAL (Solo se ejecuta si 'dependency_check' tiene éxito)
  prebuild:
    needs: [dependency_check]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repositorio actual (hormigasais-lab)
        uses: actions/checkout@v3

      - name: Configurar Entorno (Variables LAB)
        # Este paso simula la configuración del entorno para la instalación.
        run: |
          echo "LAB_PATH=/home/usuario/hormigasais-lab" >> $GITHUB_ENV
          echo "LAB_PYTHON=python3" >> $GITHUB_ENV
          echo "Variables de entorno LAB configuradas."

      - name: Instalar Dependencias de Python (requirements.txt)
        # Instala las dependencias en el entorno de la Actions runner.
        # Asumimos que el Dev Container también usará 'python3' como interprete.
        run: ${{ env.LAB_PYTHON }} -m pip install -r requirements.txt
        # NOTA: En GitHub Actions, el repositorio se descarga en la raíz, por lo que 
        # 'requirements.txt' está accesible directamente. Usamos ${{ env.LAB_PYTHON }}
        # para referenciar la variable 'python3'.

      - name: Setup Codespaces Prebuild
        # NOTA: La instalación de dependencias debe ocurrir antes de este paso,
        # ya que este paso es el que consolida el entorno pre-construido.
        uses: github/codespaces-prebuild@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          prebuild-name: "XOXO- Dev Container HormigasAIS Prebuild"
          branch: ${{ github.ref_name }}
          devcontainer-path: ".devcontainer/devcontainer.json"
          wait-for-completion: true

      - name: Notify on Success
        if: success()
        run: echo "✅ Prebuild for ${{ github.ref_name }} completed successfully."

      - name: Notify on Failure
        if: failure()
        run: echo "❌ Prebuild for ${{ github.ref_name }} failed. Check Actions logs."
